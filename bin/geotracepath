#!/usr/bin/ruby
require "open3"
require "geocoder"
require "ipaddr"

Open3.pipeline_r("tracepath -b " + ARGV.join(" ")) do |out|
  begin
    while line = out.readline.chomp
      addr = ""
      ipaddr = line.scan(/\(([0-9a-f:\.]+?)\)/).flatten.first
      if ipaddr
        x = IPAddr.new(ipaddr)
        unless x.private? or x.link_local? or x.loopback?
          info = Geocoder.search(ipaddr).first
          addr = [info.city, info.region, info.country].compact.uniq.join(", ")
        end
      end
      if addr.empty?
        puts line
      else
        puts "#{line}\t#{addr}"
      end
    end
  rescue EOFError # command exited
  end
end
